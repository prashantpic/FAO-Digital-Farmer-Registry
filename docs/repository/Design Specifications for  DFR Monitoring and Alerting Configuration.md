markdown
# Software Design Specification: DFR Monitoring and Alerting Configuration

## 1. Introduction

This document outlines the design specification for the `DFR_MONITORING_CONFIG` repository. This repository is responsible for storing all configuration files necessary for the Digital Farmer Registry (DFR) platform's monitoring and alerting stack. This includes configurations for Prometheus, Alertmanager, and Grafana, tailored to monitor DFR components such as Odoo application instances, PostgreSQL databases, Nginx reverse proxies, host systems, and backup job statuses.

### 1.1. Purpose

The primary purpose of this repository is to provide a centralized, version-controlled location for all monitoring configurations. This facilitates automated deployment of the monitoring stack, ensures consistency across environments (Development, Staging, Production), and allows for auditable changes to monitoring and alerting rules.

### 1.2. Scope

The scope of this repository includes:
- Prometheus configuration files (`prometheus.yml`, scrape job definitions, alerting rule files).
- Alertmanager configuration files (`alertmanager.yml`, notification templates).
- Grafana datasource provisioning files and dashboard JSON models.
- Configuration files for monitoring various DFR components including Odoo, PostgreSQL, Nginx, host systems (via Node Exporter), and DFR backup job status.

### 1.3. Definitions, Acronyms, and Abbreviations

- **DFR**: Digital Farmer Registry
- **KPI**: Key Performance Indicator
- **PromQL**: Prometheus Query Language
- **YAML**: YAML Ain't Markup Language
- **JSON**: JavaScript Object Notation
- **SLA**: Service Level Agreement
- **RTO**: Recovery Time Objective
- **RPO**: Recovery Point Objective
- **UAT**: User Acceptance Testing
- **CI/CD**: Continuous Integration/Continuous Deployment
- **MDM**: Mobile Device Management
- **SBOM**: Software Bill of Materials

## 2. System Overview

The `DFR_MONITORING_CONFIG` repository provides the declarative configuration for a comprehensive monitoring and alerting solution. Prometheus will collect metrics from various DFR components. Alertmanager will handle alerts generated by Prometheus based on predefined rules and route them to appropriate notification channels. Grafana will be used for visualizing metrics and system health through interactive dashboards.

This repository contributes to the `dfr_infrastructure` layer of the DFR architecture.

## 3. Design Considerations

### 3.1. Assumptions and Dependencies

-   The DFR components (Odoo, PostgreSQL, Nginx) will expose metrics in a Prometheus-compatible format, either natively or via exporters.
-   A dedicated custom exporter or metrics endpoint will be available for monitoring DFR backup job statuses.
-   The deployment environment will support running Prometheus, Alertmanager, and Grafana (likely as Docker containers).
-   Network connectivity will allow Prometheus to scrape metrics from all target DFR components.
-   Notification channel details (e.g., SMTP server, Slack webhook URLs, PagerDuty API keys) will be provided and managed securely outside this repository (e.g., via environment variables or a secure secrets management system).

### 3.2. General Design

-   **Configuration as Code:** All monitoring configurations will be stored as code (YAML, JSON) in this Git repository, enabling version control, peer review, and automated deployment.
-   **Modularity:** Configurations will be broken down into logical files (e.g., separate scrape job files, rule files per component) for better organization and maintainability.
-   **Parameterization (Environment Specificity):** While this repository holds the templates and core configurations, specific endpoint addresses or sensitive details for different environments (Dev, Staging, Prod for each country) will be managed via environment variables or a separate configuration management system that injects these values during deployment. This repository should define placeholders or conventions for such parameters.
-   **Scalability:** The design of scrape jobs and alerting rules should consider the potential for scaling DFR instances (e.g., multiple Odoo workers, multiple country instances). Service discovery mechanisms will be preferred over static configurations where appropriate.

## 4. Repository Structure and File Design

The repository will follow the file structure defined in `file_structure_json`. Each file's design is detailed below.

### 4.1. Prometheus Configuration (`prometheus/`)

#### 4.1.1. `prometheus/prometheus.yml`
   -   **Purpose:** Main Prometheus configuration.
   -   **Content Specification:**
        -   `global`:
            -   `scrape_interval`: Default scrape interval (e.g., `15s`).
            -   `evaluation_interval`: Default rule evaluation interval (e.g., `15s`).
            -   `external_labels`: Optional labels to add to all metrics (e.g., `monitor: 'dfr-platform'`).
        -   `rule_files`:
            -   Array of paths to rule files (e.g., `'/etc/prometheus/rules/*.yml'`).
        -   `scrape_configs_files`: (If using file-based scrape config inclusion, though direct inclusion in `scrape_configs` is more common)
            -   Array of paths to scrape job definition files (e.g., `'/etc/prometheus/scrape_configs/*.yml'`).
        -   `scrape_configs`:
            -   This section will directly include the content of individual scrape job files or use `file_sd_configs` to discover targets from files that can be dynamically updated. For simplicity in this initial SDS, we'll assume direct inclusion or reference to files that are part of the deployment package derived from this repository.
            -   It will reference specific job definitions from the `prometheus/scrape_configs/` directory.
        -   `alerting`:
            -   `alertmanagers`:
                -   `static_configs`:
                    -   `targets`: List of Alertmanager instances (e.g., `['alertmanager:9093']`).
   -   **Logic Description:** Orchestrates metric collection, rule evaluation, and alert forwarding by referencing modular configuration files for rules and scrape jobs.
   -   **Requirement Mapping:** REQ-DIO-009, A.2.4

#### 4.1.2. Scrape Configurations (`prometheus/scrape_configs/`)

##### 4.1.2.1. `prometheus/scrape_configs/odoo_exporter_jobs.yml`
   -   **Purpose:** Define scrape jobs for DFR Odoo instances.
   -   **Content Specification (Example Job):**
        yaml
        - job_name: 'dfr_odoo_app'
          # Assuming a custom exporter or odoo_prometheus_exporter
          metrics_path: /metrics 
          # Service discovery (e.g., file_sd or static_configs)
          # Example: static_configs for a single instance
          static_configs:
            - targets: ['odoo_app_instance1_host:8070', 'odoo_app_instance2_host:8070'] # Placeholder for actual Odoo exporter endpoints
              labels:
                env: 'production' # Example label
                country: 'CKI' # Example label
          relabel_configs:
            # Optional: Add instance-specific labels
            - source_labels: [__address__]
              target_label: instance
        
   -   **Logic Description:** Specifies targets, metrics path, and port for Prometheus to scrape Odoo application metrics. Utilizes service discovery or static configurations to identify Odoo exporter endpoints for each country instance.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.1.2.2. `prometheus/scrape_configs/postgres_exporter_jobs.yml`
   -   **Purpose:** Define scrape jobs for DFR PostgreSQL instances.
   -   **Content Specification (Example Job):**
        yaml
        - job_name: 'dfr_postgres_db'
          metrics_path: /metrics
          static_configs:
            - targets: ['postgres_exporter_instance1_host:9187', 'postgres_exporter_instance2_host:9187'] # Placeholder for actual exporter endpoints
              labels:
                env: 'production'
                country: 'CKI'
        
   -   **Logic Description:** Configures Prometheus to collect metrics from PostgreSQL exporters, targeting each country's database instance.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.1.2.3. `prometheus/scrape_configs/nginx_exporter_jobs.yml`
   -   **Purpose:** Define scrape jobs for DFR Nginx instances.
   -   **Content Specification (Example Job):**
        yaml
        - job_name: 'dfr_nginx_proxy'
          # Assuming nginx-prometheus-exporter or stub_status_exporter
          metrics_path: /metrics # or /stub_status for native module
          static_configs:
            - targets: ['nginx_instance1_host:9113', 'nginx_instance2_host:9113'] # Placeholder for actual exporter/stub_status endpoints
              labels:
                env: 'production'
                country: 'CKI'
        
   -   **Logic Description:** Configures Prometheus to scrape metrics from Nginx reverse proxies, providing insights into web traffic.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.1.2.4. `prometheus/scrape_configs/node_exporter_jobs.yml`
   -   **Purpose:** Define scrape jobs for host system metrics via Node Exporter.
   -   **Content Specification (Example Job):**
        yaml
        - job_name: 'dfr_host_nodes'
          metrics_path: /metrics
          static_configs:
            - targets: ['host1_ip:9100', 'host2_ip:9100'] # Placeholder for actual server IPs running Node Exporter
              labels:
                env: 'production'
                role: 'app_server' # Example
        
   -   **Logic Description:** Enables scraping of OS-level metrics from all servers hosting DFR components.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.1.2.5. `prometheus/scrape_configs/backup_status_exporter_jobs.yml`
   -   **Purpose:** Define scrape jobs for DFR backup status monitoring.
   -   **Content Specification (Example Job):**
        yaml
        - job_name: 'dfr_backup_status'
          metrics_path: /metrics # Path for the backup status exporter
          static_configs:
            - targets: ['backup_monitor_host:9901'] # Placeholder for the backup status exporter endpoint
              labels:
                env: 'production'
        
   -   **Logic Description:** Configures Prometheus to collect metrics on the success, failure, and duration of DFR backup operations.
   -   **Requirement Mapping:** REQ-SADG-011, REQ-DIO-009, A.2.4

#### 4.1.3. Alerting Rules (`prometheus/rules/`)

##### 4.1.3.1. `prometheus/rules/general_system_alerts.yml`
   -   **Purpose:** Define alerts for general system health.
   -   **Content Specification (Example Rule Group):**
        yaml
        groups:
        - name: general_system_alerts
          rules:
          - alert: InstanceDown
            expr: up == 0
            for: 5m
            labels:
              severity: critical
              service: system
            annotations:
              summary: "Instance {{ $labels.instance }} down"
              description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes."
          - alert: HighCpuUsage
            expr: (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 90
            for: 10m
            labels:
              severity: warning
              service: system
            annotations:
              summary: "High CPU usage on {{ $labels.instance }}"
              description: "CPU usage is {{ $value | printf \"%.2f\" }}% on instance {{ $labels.instance }} for more than 10 minutes."
          - alert: LowMemoryAvailable
            expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100) < 10
            for: 5m
            labels:
              severity: critical
              service: system
            annotations:
              summary: "Low memory available on {{ $labels.instance }}"
              description: "Less than 10% ({{ $value | printf \"%.2f\" }}%) memory available on instance {{ $labels.instance }}."
          - alert: LowDiskSpace
            expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"} * 100) < 10
            for: 1h # Less frequent check as disk space changes slower
            labels:
              severity: critical
              service: system
            annotations:
              summary: "Low disk space on {{ $labels.instance }} (mountpoint /)"
              description: "Less than 10% ({{ $value | printf \"%.2f\" }}%) disk space available on {{ $labels.instance }} for mountpoint /."
        
   -   **Logic Description:** Defines rules for critical system issues like server down, high CPU/memory utilization, and low disk space.
   -   **Requirement Mapping:** REQ-DIO-009, A.2.4

##### 4.1.3.2. `prometheus/rules/odoo_specific_alerts.yml`
   -   **Purpose:** Define alerts specific to DFR Odoo application.
   -   **Content Specification (Example Rule Group):**
        yaml
        groups:
        - name: odoo_application_alerts
          rules:
          - alert: OdooHighErrorRate
            expr: sum(rate(odoo_http_requests_total{status=~"5.."}[5m])) by (instance, job, country) / sum(rate(odoo_http_requests_total[5m])) by (instance, job, country) * 100 > 5
            for: 5m
            labels:
              severity: critical
              service: odoo
            annotations:
              summary: "High Odoo HTTP 5xx error rate on {{ $labels.instance }} (Country: {{ $labels.country }})"
              description: "Odoo instance {{ $labels.instance }} is experiencing an error rate of {{ $value | printf \"%.2f\" }}%."
          - alert: OdooSlowResponseTime
            # This metric would ideally come from a custom exporter or odoo_prometheus_exporter
            # Example: odoo_http_request_duration_seconds_bucket
            expr: histogram_quantile(0.95, sum(rate(odoo_http_request_duration_seconds_bucket[5m])) by (le, instance, job, country)) > 2 
            for: 10m
            labels:
              severity: warning
              service: odoo
            annotations:
              summary: "Slow Odoo response time on {{ $labels.instance }} (Country: {{ $labels.country }})"
              description: "95th percentile Odoo response time is above 2s on {{ $labels.instance }}."
          # Add alerts for Odoo worker availability if metrics are available
          # Example: odoo_running_workers < odoo_configured_workers * 0.5
        
   -   **Logic Description:** Focuses on Odoo application health, including HTTP error rates and response times. Assumes relevant metrics are exported.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.1.3.3. `prometheus/rules/postgres_specific_alerts.yml`
   -   **Purpose:** Define alerts specific to DFR PostgreSQL database.
   -   **Content Specification (Example Rule Group):**
        yaml
        groups:
        - name: postgres_database_alerts
          rules:
          - alert: PostgresTooManyConnections
            expr: pg_stat_activity_count{datname!~"template.*|postgres"} > (pg_settings_max_connections * 0.8)
            for: 5m
            labels:
              severity: warning
              service: postgresql
            annotations:
              summary: "High PostgreSQL connection count on {{ $labels.instance }}"
              description: "PostgreSQL instance {{ $labels.instance }} has {{ $value }} active connections, nearing max_connections."
          - alert: PostgresReplicationLagHigh
            expr: pg_replication_lag > 300 # Lag in seconds (5 minutes)
            for: 10m
            labels:
              severity: critical
              service: postgresql
            annotations:
              summary: "High PostgreSQL replication lag on {{ $labels.instance }}"
              description: "PostgreSQL replication lag is {{ $value }}s on instance {{ $labels.instance }}."
          # Add alerts for slow queries if metrics are available from exporter
          # Add alerts for low disk space on PG data directory (covered by general_system_alerts if on same mount)
        
   -   **Logic Description:** Monitors critical database metrics like connection counts and replication lag.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.1.3.4. `prometheus/rules/nginx_specific_alerts.yml`
   -   **Purpose:** Define alerts specific to DFR Nginx reverse proxy.
   -   **Content Specification (Example Rule Group):**
        yaml
        groups:
        - name: nginx_proxy_alerts
          rules:
          - alert: NginxHigh5xxErrorRate
            expr: sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) by (instance, job, country) / sum(rate(nginx_http_requests_total[5m])) by (instance, job, country) * 100 > 2
            for: 5m
            labels:
              severity: warning
              service: nginx
            annotations:
              summary: "High Nginx HTTP 5xx error rate on {{ $labels.instance }} (Country: {{ $labels.country }})"
              description: "Nginx instance {{ $labels.instance }} is experiencing a 5xx error rate of {{ $value | printf \"%.2f\" }}%."
          # Add alerts for Nginx upstream errors if applicable
        
   -   **Logic Description:** Focuses on Nginx health, primarily HTTP server-side error rates.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.1.3.5. `prometheus/rules/backup_failure_alerts.yml`
   -   **Purpose:** Define alerts for DFR backup job failures.
   -   **Content Specification (Example Rule Group):**
        yaml
        groups:
        - name: backup_status_alerts
          rules:
          - alert: DFRBackupJobFailed
            expr: backup_last_status != 0 # Assumes metric 'backup_last_status' where 0 is success
            for: 1m # Alert quickly on failure
            labels:
              severity: critical
              service: backup
            annotations:
              summary: "DFR Backup Job Failed on instance {{ $labels.instance }} (Country: {{ $labels.country }})"
              description: "The last DFR backup job for instance {{ $labels.instance }} reported a failure. Check backup logs immediately."
          - alert: DFRBackupTooOld
            expr: time() - backup_last_success_timestamp_seconds > 25 * 3600 # Older than 25 hours
            for: 1h
            labels:
              severity: critical
              service: backup
            annotations:
              summary: "DFR Backup is too old for instance {{ $labels.instance }} (Country: {{ $labels.country }})"
              description: "The last successful DFR backup for instance {{ $labels.instance }} is older than 25 hours. Last success was at {{ $value | मानव टाइमस्टैम्प }}. Investigate backup system."
        
   -   **Logic Description:** Triggers critical alerts if backup jobs fail or if the last successful backup is too old. Assumes specific metrics exposed by the backup status exporter.
   -   **Requirement Mapping:** REQ-SADG-011, REQ-DIO-009, A.2.4

### 4.2. Alertmanager Configuration (`alertmanager/`)

#### 4.2.1. `alertmanager/alertmanager.yml`
   -   **Purpose:** Main Alertmanager configuration.
   -   **Content Specification:**
        yaml
        global:
          # smtp_smarthost, smtp_from, smtp_auth_username, smtp_auth_password 
          # should be configured via environment variables or a secrets management solution
          # For example, using templating for secrets:
          # smtp_smarthost: '{{ env "SMTP_SMARTHOST" }}'
          # smtp_from: '{{ env "SMTP_FROM" }}'
          # smtp_auth_username: '{{ env "SMTP_USERNAME" }}'
          # smtp_auth_password: '{{ env "SMTP_PASSWORD" }}'
          # Alternatively, point to a file containing secrets:
          # smtp_auth_password_file: '/etc/alertmanager/smtp_password.txt'

          # Slack API URL (if used)
          # slack_api_url: '{{ env "SLACK_API_URL" }}'
          # slack_api_url_file: '/etc/alertmanager/slack_url.txt'
          
        route:
          group_by: ['alertname', 'country', 'service']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
          receiver: 'default-email-receiver' # Default receiver
        
          routes:
            - receiver: 'critical-alerts-pager'
              match_re:
                severity: critical
              continue: true # Allow critical alerts to also go to default
        
            - receiver: 'db-admins-email'
              match:
                service: postgresql
              continue: true
        
            - receiver: 'backup-ops-email'
              match:
                service: backup
              continue: true

        receivers:
        - name: 'default-email-receiver'
          email_configs:
          - to: 'dfr-support-group@example.com' # Placeholder, configure per country/env
            send_resolved: true
            html: '{{ template "dfr.email.html_body" . }}'
            headers:
              Subject: '{{ template "dfr.email.subject" . }}'

        - name: 'critical-alerts-pager'
          # Example PagerDuty configuration (replace with actual integration)
          # pagerduty_configs:
          # - service_key: '{{ env "PAGERDUTY_SERVICE_KEY_CRITICAL" }}'
          email_configs: # Fallback or alternative for criticals
          - to: 'dfr-critical-oncall@example.com' # Placeholder
            html: '{{ template "dfr.email.html_body_critical" . }}'
            headers:
              Subject: '[CRITICAL] {{ template "dfr.email.subject" . }}'

        - name: 'db-admins-email'
          email_configs:
          - to: 'dfr-db-admins@example.com' # Placeholder
            send_resolved: true
            html: '{{ template "dfr.email.html_body" . }}'
            headers:
              Subject: '[DB Alert] {{ template "dfr.email.subject" . }}'
        
        - name: 'backup-ops-email'
          email_configs:
          - to: 'dfr-backup-ops@example.com' # Placeholder
            send_resolved: true
            html: '{{ template "dfr.email.html_body" . }}'
            headers:
              Subject: '[Backup Alert] {{ template "dfr.email.subject" . }}'

        # Example for Slack receiver
        # - name: 'slack-notifications'
        #   slack_configs:
        #   - channel: '#dfr-alerts'
        #     send_resolved: true
        #     text: '{{ template "dfr.slack.message" . }}'

        templates:
        - '/etc/alertmanager/templates/*.tmpl'
        
   -   **Logic Description:** Defines alert routing based on labels (e.g., severity, service), specifies receivers (email, potentially Slack/PagerDuty placeholders), and references custom notification templates. Sensitive information like SMTP passwords or API keys must be injected at deployment time, not stored in this file.
   -   **Requirement Mapping:** REQ-DIO-009, A.2.4

#### 4.2.2. `alertmanager/templates/notification_templates.tmpl`
   -   **Purpose:** Custom Go templates for Alertmanager notifications.
   -   **Content Specification:**
        html
        {{ define "dfr.email.subject" }}
        [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.service }} {{ if .CommonLabels.country }}({{ .CommonLabels.country }}){{ end }}
        {{ end }}

        {{ define "dfr.email.html_body" }}
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>DFR Alert</title>
        </head>
        <body>
            <h2>DFR Monitoring Alert</h2>
            <p><strong>Status:</strong> {{ .Status | toUpper }}</p>
            {{ range .Alerts }}
            <hr>
            <p><strong>Alert:</strong> {{ .Labels.alertname }} ({{ .Labels.severity | toUpper }})</p>
            <p><strong>Service:</strong> {{ .Labels.service }}</p>
            {{ if .Labels.country }}<p><strong>Country:</strong> {{ .Labels.country }}</p>{{ end }}
            {{ if .Labels.instance }}<p><strong>Instance:</strong> {{ .Labels.instance }}</p>{{ end }}
            <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
            <p><strong>Description:</strong> {{ .Annotations.description }}</p>
            <p><strong>Starts At:</strong> {{ .StartsAt | humanTime }}</p>
            {{ if eq .Status "resolved" }}<p><strong>Ends At:</strong> {{ .EndsAt | humanTime }}</p>{{ end }}
            <p><a href="{{ .GeneratorURL }}">Prometheus Alert Link</a></p>
            {{ end }}
        </body>
        </html>
        {{ end }}

        {{ define "dfr.email.html_body_critical" }}
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>CRITICAL DFR Alert</title>
            <style> body { background-color: #ffdddd; } </style>
        </head>
        <body>
            <h1 style="color: red;">CRITICAL DFR Monitoring Alert</h1>
            <p><strong>Status:</strong> {{ .Status | toUpper }}</p>
            {{ range .Alerts }}
            <hr>
            <p><strong>Alert:</strong> {{ .Labels.alertname }} (<strong>{{ .Labels.severity | toUpper }}</strong>)</p>
            <p><strong>Service:</strong> {{ .Labels.service }}</p>
            {{ if .Labels.country }}<p><strong>Country:</strong> {{ .Labels.country }}</p>{{ end }}
            {{ if .Labels.instance }}<p><strong>Instance:</strong> {{ .Labels.instance }}</p>{{ end }}
            <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
            <p><strong>Description:</strong> {{ .Annotations.description }}</p>
            <p><strong>Starts At:</strong> {{ .StartsAt | humanTime }}</p>
            <p><a href="{{ .GeneratorURL }}">Prometheus Alert Link</a></p>
            {{ end }}
        </body>
        </html>
        {{ end }}

        {{ define "dfr.slack.message" }}
        {{ range .Alerts }}
        *[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .Labels.alertname }}* for `{{ .Labels.service }}`{{ if .Labels.country }} (`{{ .Labels.country }}`){{ end }}
        Severity: `{{ .Labels.severity }}`
        {{ if .Labels.instance }}Instance: `{{ .Labels.instance }}`{{ end }}
        Summary: {{ .Annotations.summary }}
        Description: {{ .Annotations.description }}
        <{{ .GeneratorURL }}|View in Prometheus>
        {{ end }}
        {{ end }}
        
        *Note: `humanTime` is a hypothetical Go template function that would format timestamps. Alertmanager has built-in ways to format time.*
   -   **Logic Description:** Provides HTML templates for email notifications and a text template for Slack messages, making alerts more readable and informative. Includes specific templates for critical alerts.
   -   **Requirement Mapping:** REQ-DIO-009

### 4.3. Grafana Configuration (`grafana/`)

#### 4.3.1. Datasource Provisioning (`grafana/datasources/prometheus_datasource.yml`)
   -   **Purpose:** Automate Prometheus datasource configuration in Grafana.
   -   **Content Specification:**
        yaml
        apiVersion: 1

        datasources:
          - name: DFR-Prometheus
            type: prometheus
            url: http://prometheus:9090 # URL to Prometheus server, adjust if different
            access: server # Grafana backend makes requests
            isDefault: true
            jsonData:
              timeInterval: "15s" # Default scrape interval for dashboards
            editable: true # Allow admins to edit in Grafana UI if needed
        
   -   **Logic Description:** Ensures Grafana can connect to Prometheus to query metrics for dashboards. The `url` should point to the Prometheus service as resolvable from the Grafana container.
   -   **Requirement Mapping:** REQ-DIO-009

#### 4.3.2. Dashboard Definitions (`grafana/dashboards/`)

   Files in this directory are JSON models exported from Grafana or created manually following the Grafana dashboard JSON schema. Each dashboard definition will visualize specific sets of metrics.

##### 4.3.2.1. `grafana/dashboards/dfr_system_overview.json`
   -   **Purpose:** High-level DFR system health dashboard.
   -   **Content Specification Outline (conceptual):**
        -   **Title:** "DFR System Overview"
        -   **Templating Variables:** `country_instance` (dropdown to select specific country if metrics are labeled accordingly).
        -   **Panels:**
            -   Stat panel: "Total Active Farmers" (PromQL: `sum(dfr_active_farmers_total{country="$country_instance"})`)
            -   Stat panel: "DFR API Availability (Overall)" (PromQL: `avg(up{job=~"dfr_.*_api", country="$country_instance"}) * 100`)
            -   Graph: "Registration Trends (Last 7d)" (PromQL: `sum(rate(dfr_registrations_total{country="$country_instance"}[1h])) by (country)`)
            -   Graph: "Odoo App Server CPU Usage" (PromQL: `avg(node_cpu_seconds_total{job="dfr_host_nodes", mode!="idle", role="odoo_app", country="$country_instance"}) by (instance) * 100`)
            -   Table: "Alerting Status" (showing active alerts from Alertmanager - might require specific Alertmanager metrics or a plugin)
            -   Stat panel: "Last Successful Backup" (PromQL: `time() - backup_last_success_timestamp_seconds{country="$country_instance"}`)
            -   Stat panel: "Backup Failures (Last 24h)" (PromQL: `sum(increase(backup_failures_total{country="$country_instance"}[24h]))`)
   -   **Logic Description:** Uses PromQL queries targeting metrics from Odoo, Nginx, PostgreSQL, Node Exporter, and backup status exporter to provide a consolidated view of the DFR platform's state. Assumes relevant metrics are available and labeled with `country` if applicable.
   -   **Requirement Mapping:** REQ-DIO-009, REQ-CM-011, REQ-TSE-008, A.2.4

##### 4.3.2.2. `grafana/dashboards/odoo_application_performance.json`
   -   **Purpose:** Detailed Odoo application performance.
   -   **Content Specification Outline (conceptual):**
        -   **Title:** "DFR Odoo Application Performance - {{ $country_instance }}"
        -   **Templating Variables:** `country_instance`, `odoo_instance`.
        -   **Panels:**
            -   Graph: "HTTP Request Rate (per instance)" (PromQL: `sum(rate(odoo_http_requests_total{job="dfr_odoo_app", country="$country_instance", instance="$odoo_instance"}[1m])) by (path, method)`)
            -   Graph: "HTTP Request Latency (95th percentile)" (PromQL: `histogram_quantile(0.95, sum(rate(odoo_http_request_duration_seconds_bucket{job="dfr_odoo_app", country="$country_instance", instance="$odoo_instance"}[5m])) by (le, path))`)
            -   Graph: "HTTP Error Rate (5xx)" (PromQL: `sum(rate(odoo_http_requests_total{job="dfr_odoo_app", status=~"5..", country="$country_instance", instance="$odoo_instance"}[1m])) by (path)`)
            -   Stat panel: "Active Odoo Workers" (PromQL: `odoo_active_workers{job="dfr_odoo_app", country="$country_instance", instance="$odoo_instance"}`)
            -   Graph: "Odoo RPC Call Volume/Latency" (if metrics available)
   -   **Logic Description:** Focuses on metrics exported by Odoo instances (e.g., via `odoo_prometheus_exporter` or a custom exporter), providing insights into request handling, latency, and error rates.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.3.2.3. `grafana/dashboards/postgresql_database_health.json`
   -   **Purpose:** PostgreSQL database health and performance.
   -   **Content Specification Outline (conceptual):**
        -   **Title:** "DFR PostgreSQL Health - {{ $country_instance }}"
        -   **Templating Variables:** `country_instance`, `pg_instance`.
        -   **Panels:**
            -   Graph: "Connections by State" (PromQL: `sum(pg_stat_activity_count{datname!~"template.|postgres", job="dfr_postgres_db", country="$country_instance", instance="$pg_instance"}) by (state)`)
            -   Graph: "Transactions per Second (TPS)" (PromQL: `sum(rate(pg_stat_database_xact_commit{datname!~"template.|postgres", job="dfr_postgres_db", country="$country_instance", instance="$pg_instance"}[5m]) + rate(pg_stat_database_xact_rollback{datname!~"template.|postgres", job="dfr_postgres_db", country="$country_instance", instance="$pg_instance"}[5m])) by (datname)`)
            -   Graph: "Index Hit Rate" (PromQL: `sum(pg_statio_user_indexes_idx_blks_hit{datname!~"template.|postgres", job="dfr_postgres_db", country="$country_instance", instance="$pg_instance"}) / (sum(pg_statio_user_indexes_idx_blks_hit{datname!~"template.|postgres", job="dfr_postgres_db", country="$country_instance", instance="$pg_instance"}) + sum(pg_statio_user_indexes_idx_blks_read{datname!~"template.|postgres", job="dfr_postgres_db", country="$country_instance", instance="$pg_instance"})) * 100`)
            -   Graph: "Replication Lag (if applicable)" (PromQL: `pg_replication_lag{job="dfr_postgres_db", country="$country_instance", instance="$pg_instance"}`)
            -   Graph: "Slow Queries Count" (if metric available from exporter)
   -   **Logic Description:** Visualizes key PostgreSQL performance indicators using metrics from the PostgreSQL exporter.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.3.2.4. `grafana/dashboards/nginx_web_traffic.json`
   -   **Purpose:** Nginx reverse proxy monitoring.
   -   **Content Specification Outline (conceptual):**
        -   **Title:** "DFR Nginx Web Traffic - {{ $country_instance }}"
        -   **Templating Variables:** `country_instance`, `nginx_instance`.
        -   **Panels:**
            -   Graph: "Requests per Second" (PromQL: `sum(rate(nginx_http_requests_total{job="dfr_nginx_proxy", country="$country_instance", instance="$nginx_instance"}[1m])) by (status)`)
            -   Graph: "HTTP Status Codes" (PromQL: `sum(rate(nginx_http_requests_total{job="dfr_nginx_proxy", country="$country_instance", instance="$nginx_instance"}[1m])) by (status)`)
            -   Graph: "Active Connections" (PromQL: `nginx_connections_active{job="dfr_nginx_proxy", country="$country_instance", instance="$nginx_instance"}`)
            -   Graph: "Upstream Response Time (if applicable)"
   -   **Logic Description:** Shows metrics from Nginx, focusing on request rates, status codes, and connection handling.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.3.2.5. `grafana/dashboards/host_node_metrics.json`
   -   **Purpose:** Host system metrics from Node Exporter.
   -   **Content Specification Outline (conceptual):**
        -   **Title:** "DFR Host Metrics - {{ $instance }}"
        -   **Templating Variables:** `instance` (Node Exporter instance).
        -   **Panels:**
            -   Graph: "CPU Utilization %" (PromQL: `100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle", instance="$instance"}[1m])) * 100)`)
            -   Graph: "Memory Utilization %" (PromQL: `(1 - (node_memory_MemAvailable_bytes{instance="$instance"} / node_memory_MemTotal_bytes{instance="$instance"})) * 100`)
            -   Graph: "Disk Space Used % (root)" (PromQL: `(node_filesystem_size_bytes{mountpoint="/", instance="$instance"} - node_filesystem_avail_bytes{mountpoint="/", instance="$instance"}) / node_filesystem_size_bytes{mountpoint="/", instance="$instance"} * 100`)
            -   Graph: "Disk I/O (Read/Write)" (PromQL: `rate(node_disk_read_bytes_total{instance="$instance"}[1m])`, `rate(node_disk_written_bytes_total{instance="$instance"}[1m])`)
            -   Graph: "Network Traffic (In/Out)" (PromQL: `rate(node_network_receive_bytes_total{instance="$instance"}[1m])`, `rate(node_network_transmit_bytes_total{instance="$instance"}[1m])`)
            -   Stat panel: "Load Average (1m, 5m, 15m)"
   -   **Logic Description:** Visualizes fundamental OS-level metrics for each server in the DFR infrastructure.
   -   **Requirement Mapping:** REQ-DIO-009

##### 4.3.2.6. `grafana/dashboards/backup_operations_status.json`
   -   **Purpose:** Monitor DFR backup job status.
   -   **Content Specification Outline (conceptual):**
        -   **Title:** "DFR Backup Operations Status - {{ $country_instance }}"
        -   **Templating Variables:** `country_instance`.
        -   **Panels:**
            -   Stat panel: "Last Backup Status" (PromQL: `backup_last_status{country="$country_instance"}` - 0 for success, 1 for failure)
            -   Stat panel: "Time Since Last Successful Backup" (PromQL: `time() - backup_last_success_timestamp_seconds{country="$country_instance"}`)
            -   Graph: "Backup Durations (Last 7)" (PromQL: `backup_duration_seconds{country="$country_instance"}`)
            -   Table: "Recent Backup History" (showing timestamp, status, duration)
   -   **Logic Description:** Provides a clear overview of backup job health, success rates, and timings.
   -   **Requirement Mapping:** REQ-SADG-011, REQ-DIO-009, A.2.4

## 5. Deployment and Operational Considerations

-   **Provisioning:** Grafana dashboards and datasource configurations should be provisioned automatically upon Grafana startup (e.g., by mounting these configuration files into the Grafana Docker container at specific paths).
-   **Secrets Management:** Sensitive data for Alertmanager (SMTP credentials, API keys for other notification channels) must be handled securely, preferably injected as environment variables or through a secrets management tool, not hardcoded in `alertmanager.yml`.
-   **Exporters:** The various Prometheus exporters (Node, PostgreSQL, Odoo, Nginx, Backup Status) need to be deployed and configured on their respective target systems or as sidecars. Their configuration is outside the scope of this repository but their scrape job definitions are included.
-   **Labels:** Consistent use of labels (e.g., `country`, `env`, `service`, `instance`) in Prometheus scrape jobs and alerting rules is crucial for effective filtering, routing, and dashboarding.
-   **Updates:** Changes to these configuration files should be tested in a staging monitoring environment before being applied to production.

## 6. Non-Functional Requirements Addressed

-   **REQ-DIO-009:** System monitoring capabilities and alert thresholds are directly implemented through these configurations.
-   **REQ-SADG-011:** Backup status monitoring and alerting contribute to ensuring backup procedures are effective.
-   **REQ-CM-011:** The system health and performance metrics visualized in Grafana dashboards will be key inputs for the quarterly reports.
-   **REQ-TSE-008:** The monitoring system (Prometheus, Grafana) and alerts (Alertmanager) form part of the support infrastructure. System performance monitoring is a key aspect of the support services.
-   **A.2.4 (SRS):** System monitoring protocols and backup monitoring are addressed.

This SDS provides the blueprint for the configuration files that will drive the DFR monitoring and alerting stack.
